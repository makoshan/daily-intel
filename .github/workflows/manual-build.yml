name: Manual Build & Deploy

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Newsletter date (YYYY-MM-DD, leave empty for today)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install feedparser requests
    
    - name: Generate Newsletter
      run: |
        if [ -z "${{ github.event.inputs.date }}" ]; then
          python scripts/daily_newsletter_page.py
        else
          python scripts/daily_newsletter_page.py "${{ github.event.inputs.date }}"
        fi
    
    - name: Set up Haskell
      uses: haskell/actions/setup@v2
      with:
        ghc-version: '9.2.8'
        cabal-version: '3.10.1.0'
    
    - name: Build site
      run: |
        cd build
        cabal update
        cabal build
        cabal run hakyll -- rebuild +RTS -N -RTS
    
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        publish_branch: gh-pages
