name: éƒ¨ç½² Daily Intel

on:
  # æ¯å¤© 08:00 UTC+8 (00:00 UTC) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # Push åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '**.page'
      - '.github/workflows/deploy.yml'

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äº git æ“ä½œ
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£… Python ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install feedparser requests python-dotenv beautifulsoup4
      
      # 4. ç”Ÿæˆ Newsletter
      - name: ç”Ÿæˆ Newsletter
        run: |
          python scripts/daily_newsletter_page.py
        env:
          TZ: Asia/Shanghai
      
      # 5. è®¾ç½® Haskell ç¯å¢ƒ
      - name: è®¾ç½® Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.4.8'
          cabal-version: '3.10.2.0'
      
      # 6. ç¼“å­˜ Cabal ä¾èµ–
      - name: ç¼“å­˜ Cabal
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-
      
      # 7. ç¼–è¯‘ Hakyll
      - name: ç¼–è¯‘ Hakyll ç«™ç‚¹
        run: |
          cd build
          cabal update
          cabal build
          cabal run hakyll -- clean
          cabal run hakyll -- build
      
      # 8. éƒ¨ç½²åˆ° GitHub Pages
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ éƒ¨ç½²: ${{ github.event.head_commit.message }}'
      
      # 9. æäº¤æ–°ç”Ÿæˆçš„ Newsletter (å¦‚æœæœ‰)
      - name: æäº¤ Newsletter
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ·»åŠ æ–°ç”Ÿæˆçš„æ–‡ä»¶
          git add newsletter/*.page
          git add newsletter/topics.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„ Newsletter ç”Ÿæˆ"
          else
            git commit -m "ğŸ“° è‡ªåŠ¨ç”Ÿæˆ Newsletter $(date +'%Y-%m-%d')"
            git push
          fi
